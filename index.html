<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authority Gap Diagnostic Tool | strategyhub.co.uk</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary: #1a3a4b;
            --secondary: #0f2332;
            --accent: #f59e0b;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --light: #fafbfc;
            --dark: #111827;
            --border: #e5e7eb;
            --subtle-bg: #f8f9fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: var(--dark);
            background: var(--light);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--primary);
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            padding: 30px 0;
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .brand h1 {
            font-family: 'Libre Baskerville', Georgia, 'Times New Roman', serif;
            color: white;
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 8px;
        }

        .tagline {
            color: rgba(255,255,255,0.85);
            font-size: 1rem;
            font-weight: 400;
            letter-spacing: 0.01em;
        }

        .progress-indicator {
            background: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }

        .progress-text {
            font-weight: 600;
            color: var(--primary);
            white-space: nowrap;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
        }

        .panel h2 {
            font-family: 'Libre Baskerville', Georgia, 'Times New Roman', serif;
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.6rem;
            font-weight: 700;
            letter-spacing: -0.01em;
        }

        .panel h3 {
            font-family: 'Libre Baskerville', Georgia, 'Times New Roman', serif;
            font-weight: 700;
        }

        .panel h4 {
            font-family: 'Libre Baskerville', Georgia, 'Times New Roman', serif;
            font-weight: 700;
        }

        .metric-card {
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 15px;
            overflow: visible;
            transition: border-color 0.3s;
        }

        .metric-card.needs-attention {
            border-color: #fbbf24;
            background: #fffbeb;
        }

        .metric-header {
            padding: 15px;
            background: var(--subtle-bg);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
            position: relative;
            overflow: visible;
        }

        .metric-header:hover {
            background: #f0f1f3;
        }

        .metric-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .metric-badge {
            background: var(--primary);
            color: white;
            padding: 3px 9px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            letter-spacing: 0.02em;
        }

        .help-icon {
            width: 18px;
            height: 18px;
            background: var(--secondary);
            color: white;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            cursor: help;
            position: relative;
            font-weight: 700;
            z-index: 10;
        }

        .tooltip {
            position: absolute;
            bottom: 28px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: white;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 0.85rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
            width: 280px;
            white-space: normal;
            line-height: 1.5;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--dark);
        }

        .help-icon:hover .tooltip {
            opacity: 1;
        }

        .metric-body {
            padding: 15px;
            display: none;
            background: white;
        }

        .metric-body.active {
            display: block;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-field label {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
        }

        .input-field input {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 0.95rem;
        }

        .input-field input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(15, 35, 50, 0.1);
        }

        .input-field input.invalid {
            border-color: var(--danger);
        }

        .validation-message {
            color: var(--danger);
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        .validation-message.warning {
            color: var(--warning);
        }

        .validation-message.show {
            display: block;
        }

        .status-chip {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-green {
            background: #d1fae5;
            color: var(--success);
        }

        .status-amber {
            background: #fed7aa;
            color: var(--warning);
        }

        .status-red {
            background: #fee2e2;
            color: var(--danger);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .metric-summary {
            background: var(--subtle-bg);
            padding: 18px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .metric-summary h3 {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chart-container canvas {
            max-width: 100%;
            max-height: 100%;
        }

        .insight-item {
            background: var(--subtle-bg);
            padding: 18px;
            border-left: 4px solid var(--secondary);
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .insight-item h4 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.05rem;
        }

        .insight-impact {
            color: var(--danger);
            font-weight: 600;
            margin: 8px 0;
        }

        .insight-action {
            color: var(--success);
            font-weight: 500;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary);
        }

        .btn-secondary {
            background: var(--success);
            color: white;
        }

        .btn-secondary:hover {
            background: #047857;
        }

        .recovery-timeline {
            background: #0d9488;
            color: white;
            padding: 25px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .recovery-timeline h3 {
            margin-bottom: 18px;
            font-size: 1.3rem;
            color: white;
        }

        .snapshot-comparison-item {
            background: var(--subtle-bg);
            padding: 12px 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
        }

        .trend-positive {
            color: var(--success);
            font-weight: 600;
        }

        .trend-negative {
            color: var(--danger);
            font-weight: 600;
        }

        .trend-neutral {
            color: #6b7280;
            font-weight: 600;
        }

        .aagi-callout {
            background: var(--subtle-bg);
            padding: 20px;
            border-left: 4px solid var(--accent);
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .aagi-callout h4 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .aagi-callout .aagi-status {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .aagi-callout .aagi-impact {
            color: var(--danger);
            font-weight: 600;
            margin: 10px 0;
        }

        .aagi-callout .aagi-action {
            color: var(--success);
            font-weight: 500;
        }

        .timeline-item {
            margin-bottom: 15px;
            padding-left: 25px;
            position: relative;
            color: white;
        }

        .timeline-item::before {
            content: "â†’";
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-content h3 {
            margin-bottom: 15px;
            color: var(--primary);
        }

        .modal-content input {
            width: 100%;
            padding: 10px;
            margin: 15px 0;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 1rem;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #6b7280;
            font-size: 0.85rem;
            border-top: 1px solid var(--border);
            margin-top: 40px;
        }

        .how-to-use {
            background: #f8fafc;
            border-left: 4px solid var(--primary);
            margin-bottom: 30px;
            padding: 25px;
            border-radius: 5px;
        }

        .how-to-use h2 {
            margin-bottom: 15px;
        }

        .how-to-use p {
            margin-bottom: 12px;
            line-height: 1.7;
        }

        .how-to-use strong {
            color: var(--primary);
            font-weight: 600;
        }

        .how-to-use ul {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .how-to-use li {
            margin-bottom: 8px;
            line-height: 1.7;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .brand h1 {
                font-size: 1.8rem;
            }

            .tooltip {
                width: 240px;
                font-size: 0.8rem;
            }
        }

        @media print {
            @page {
                size: A4;
                margin: 15mm;
            }

            body { 
                background: white;
                padding: 0;
                font-size: 11pt;
            }

            .container {
                max-width: 100%;
                padding: 0;
            }

            header {
                box-shadow: none;
                border-bottom: 2px solid var(--border);
                page-break-after: avoid;
                padding: 10px 0;
            }

            .brand h1 {
                font-size: 1.5rem;
            }

            .tagline {
                font-size: 0.8rem;
            }

            .main-grid {
                display: block;
                page-break-inside: avoid;
            }

            .panel { 
                box-shadow: none; 
                border: 1px solid var(--border); 
                page-break-inside: avoid; 
                margin-bottom: 15px;
                padding: 15px;
            }

            .panel h2 {
                font-size: 1.2rem;
                margin-bottom: 10px;
            }

            .dashboard-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
                page-break-inside: avoid;
            }

            .metric-summary {
                padding: 10px;
            }

            .metric-value {
                font-size: 1.4rem;
            }

            .action-buttons,
            .btn,
            .metric-body,
            .help-icon,
            .progress-indicator,
            .modal,
            #snapshot-panel {
                display: none;
            }

            .metric-header { 
                cursor: default; 
                background: white;
                padding: 10px;
            }

            .metric-card {
                border: none;
                margin-bottom: 8px;
            }

            .chart-container { 
                page-break-inside: avoid;
                height: 250px;
                margin-bottom: 15px;
            }

            .insight-item {
                page-break-inside: avoid;
                padding: 10px;
                margin-bottom: 10px;
            }

            .recovery-timeline {
                page-break-before: always;
                padding: 15px;
            }

            .timeline-item {
                margin-bottom: 10px;
                padding-left: 20px;
            }

            footer {
                page-break-before: avoid;
                margin-top: 20px;
                padding: 10px;
                font-size: 0.75rem;
            }

            a {
                color: var(--dark);
                text-decoration: none;
            }

            a::after {
                content: " (" attr(href) ")";
                font-size: 0.8em;
                color: #666;
            }
        }
    </style>
</head>
<body>
    <header>
        <!-- Credibility Bar -->
    <div style="background: white; padding: 15px 20px; border-bottom: 1px solid #e5e7eb; margin-bottom: 30px;">
        <div class="container">
            <div style="display: flex; gap: 30px; font-size: 0.85rem; color: #6b7280; flex-wrap: wrap; justify-content: center;">
                <span style="display: flex; align-items: center; gap: 8px;">
                    <strong style="color: var(--primary);">ðŸ“Š Framework basis:</strong> Strategic consulting practice with UK SMEs
                </span>
                <span style="display: flex; align-items: center; gap: 8px;">
                    <strong style="color: var(--primary);">âš¡ Completion time:</strong> <5 minutes with tracking data
                </span>
            </div>
        </div>
    </div>

    <div class="container">
            <div class="header-content">
                <div class="brand">
                    <h1>Strategy Hub</h1>
                    <div class="tagline">Strategic Consulting | Enterprise Value Protection</div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- How to Use Panel -->
        <div class="panel how-to-use">
            <h2>Authority Gap Diagnostic: Measurement Framework</h2>
            <div style="line-height: 1.7;">
                <p><strong>Purpose:</strong> Quantify the Â£2m problem hiding in your org chart. UK M&A transactions apply 15-25% discounts for founder dependency. This diagnostic measures whether you're building enterprise value or institutional risk.</p>
                
                <p><strong>Before you start:</strong> Track decisions for one week minimum. Count how many decisions require your approval, how many meetings need your input to close, how often you reverse delegated decisions. Without tracking data, scores reveal nothing actionable.</p>
                
                <p><strong>Using this framework:</strong></p>
                <ul style="margin-left: 20px;">
                    <li>Expand each metric card and enter tracked data</li>
                    <li>Hover over <strong>?</strong> icons for metric definitions and thresholds</li>
                    <li>Green = genuine delegation, Amber = authority theatre, Red = systematic bottleneck</li>
                    <li>Target overall score: 80+ (minimal key person risk)</li>
                </ul>
                
                <p><strong>After measurement:</strong> Address your worst 2-3 metrics first. Review "Live Contextual Insights" for specific interventions. Typical recovery timeline: 3-6 months to reduce founder dependency by 20+ points. Markets price this gap whether you measure it or not.</p>
            </div>
        </div>

        <!-- Progress Indicator -->
        <div class="progress-indicator">
            <div class="progress-text" id="progress-text">0 of 7 metrics completed (0%)</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
        </div>

        <div class="main-grid">
            <!-- Input Panel -->
            <div class="panel">
                <h2>Authority Gap Measurement</h2>
                
                <!-- AAGI - Moved to top -->
                <div class="metric-card" id="card-aagi">
                    <div class="metric-header">
                        <div class="metric-title">
                            <span>Authority-Accountability Gap Index</span>
                            <span class="metric-badge">AAGI</span>
                            <div class="help-icon">
                                ?
                                <div class="tooltip">Count of OKRs where owners lack matching decision rights. Zero is the only acceptable target. Even 1 mismatched strategic OKR signals structural governance failure.</div>
                            </div>
                        </div>
                        <span class="status-chip" id="aagi-status"></span>
                    </div>
                    <div class="metric-body active">
                        <div class="input-group">
                            <div class="input-field">
                                <label>OKRs with mismatched authority</label>
                                <input type="number" id="aagi-raw1" placeholder="e.g. 3" min="0">
                                <div class="validation-message" id="aagi-raw1-error"></div>
                            </div>
                            <div class="input-field">
                                <label>Total OKRs</label>
                                <input type="number" id="aagi-raw2" placeholder="e.g. 12" min="0">
                                <div class="validation-message" id="aagi-raw2-error"></div>
                            </div>
                        </div>
                        <div class="input-field">
                            <label>Or enter count directly</label>
                            <input type="number" id="aagi-direct" placeholder="e.g. 3" min="0">
                            <div class="validation-message" id="aagi-direct-error"></div>
                        </div>
                    </div>
                </div>

                <!-- SAR -->
                <div class="metric-card" id="card-sar">
                    <div class="metric-header">
                        <div class="metric-title">
                            <span>Shadow Approval Rate</span>
                            <span class="metric-badge">SAR</span>
                            <div class="help-icon">
                                ?
                                <div class="tooltip">Authority theatre metric. Tracks decisions you've 'delegated' but still approve. SAR >30% = systematic bottleneck. SAR <10% = genuine transfer.</div>
                            </div>
                        </div>
                        <span class="status-chip" id="sar-status"></span>
                    </div>
                    <div class="metric-body">
                        <div class="input-group">
                            <div class="input-field">
                                <label>Decisions requiring founder approval</label>
                                <input type="number" id="sar-raw1" placeholder="e.g. 45" min="0">
                                <div class="validation-message" id="sar-raw1-error"></div>
                            </div>
                            <div class="input-field">
                                <label>Total in-band decisions</label>
                                <input type="number" id="sar-raw2" placeholder="e.g. 150" min="0">
                                <div class="validation-message" id="sar-raw2-error"></div>
                            </div>
                        </div>
                        <div class="input-field">
                            <label>Or enter percentage directly</label>
                            <input type="number" id="sar-percent" placeholder="e.g. 30" min="0" max="100">
                            <div class="validation-message" id="sar-percent-error"></div>
                        </div>
                    </div>
                </div>

                <!-- ABU -->
                <div class="metric-card" id="card-abu">
                    <div class="metric-header">
                        <div class="metric-title">
                            <span>Authority Band Utilisation</span>
                            <span class="metric-badge">ABU</span>
                            <div class="help-icon">
                                ?
                                <div class="tooltip">Decisions made at intended level per published bands. If you haven't published bands, ABU = 0% by definition. Target: >80%</div>
                            </div>
                        </div>
                        <span class="status-chip" id="abu-status"></span>
                    </div>
                    <div class="metric-body">
                        <div class="input-group">
                            <div class="input-field">
                                <label>Decisions at correct level</label>
                                <input type="number" id="abu-raw1" placeholder="e.g. 120" min="0">
                                <div class="validation-message" id="abu-raw1-error"></div>
                            </div>
                            <div class="input-field">
                                <label>Total decisions tracked</label>
                                <input type="number" id="abu-raw2" placeholder="e.g. 150" min="0">
                                <div class="validation-message" id="abu-raw2-error"></div>
                            </div>
                        </div>
                        <div class="input-field">
                            <label>Or enter percentage directly</label>
                            <input type="number" id="abu-percent" placeholder="e.g. 80" min="0" max="100">
                            <div class="validation-message" id="abu-percent-error"></div>
                        </div>
                    </div>
                </div>

                <!-- FGS -->
                <div class="metric-card" id="card-fgs">
                    <div class="metric-header">
                        <div class="metric-title">
                            <span>Founder Gate Share</span>
                            <span class="metric-badge">FGS</span>
                            <div class="help-icon">
                                ?
                                <div class="tooltip">Meetings requiring founder decision to close. FGS >25% indicates you're the organisational bottleneck, not the strategic leader.</div>
                            </div>
                        </div>
                        <span class="status-chip" id="fgs-status"></span>
                    </div>
                    <div class="metric-body">
                        <div class="input-group">
                            <div class="input-field">
                                <label>Meetings needing founder decision</label>
                                <input type="number" id="fgs-raw1" placeholder="e.g. 15" min="0">
                                <div class="validation-message" id="fgs-raw1-error"></div>
                            </div>
                            <div class="input-field">
                                <label>Total meetings</label>
                                <input type="number" id="fgs-raw2" placeholder="e.g. 60" min="0">
                                <div class="validation-message" id="fgs-raw2-error"></div>
                            </div>
                        </div>
                        <div class="input-field">
                            <label>Or enter percentage directly</label>
                            <input type="number" id="fgs-percent" placeholder="e.g. 25" min="0" max="100">
                            <div class="validation-message" id="fgs-percent-error"></div>
                        </div>
                    </div>
                </div>

                <!-- DTF -->
                <div class="metric-card" id="card-dtf">
                    <div class="metric-header">
                        <div class="metric-title">
                            <span>Decision Throughput without Founder</span>
                            <span class="metric-badge">DTF</span>
                            <div class="help-icon">
                                ?
                                <div class="tooltip">Non-founder decisions resolved within SLAs. DTF <70% means organisational capability is suppressed by approval dependency. Target: >70%</div>
                            </div>
                        </div>
                        <span class="status-chip" id="dtf-status"></span>
                    </div>
                    <div class="metric-body">
                        <div class="input-group">
                            <div class="input-field">
                                <label>Non-founder decisions within SLA</label>
                                <input type="number" id="dtf-raw1" placeholder="e.g. 84" min="0">
                                <div class="validation-message" id="dtf-raw1-error"></div>
                            </div>
                            <div class="input-field">
                                <label>Total decisions</label>
                                <input type="number" id="dtf-raw2" placeholder="e.g. 120" min="0">
                                <div class="validation-message" id="dtf-raw2-error"></div>
                            </div>
                        </div>
                        <div class="input-field">
                            <label>Or enter percentage directly</label>
                            <input type="number" id="dtf-percent" placeholder="e.g. 70" min="0" max="100">
                            <div class="validation-message" id="dtf-percent-error"></div>
                        </div>
                    </div>
                </div>

                <!-- TR -->
                <div class="metric-card" id="card-tr">
                    <div class="metric-header">
                        <div class="metric-title">
                            <span>Turnback Ratio</span>
                            <span class="metric-badge">TR</span>
                            <div class="help-icon">
                                ?
                                <div class="tooltip">Delegated decisions reversed within 7 days. TR >5% signals trust deficit. Teams learn to seek approval regardless of formal authority when reversals are frequent.</div>
                            </div>
                        </div>
                        <span class="status-chip" id="tr-status"></span>
                    </div>
                    <div class="metric-body">
                        <div class="input-group">
                            <div class="input-field">
                                <label>Decisions reversed</label>
                                <input type="number" id="tr-raw1" placeholder="e.g. 3" min="0">
                                <div class="validation-message" id="tr-raw1-error"></div>
                            </div>
                            <div class="input-field">
                                <label>Total delegated decisions</label>
                                <input type="number" id="tr-raw2" placeholder="e.g. 50" min="0">
                                <div class="validation-message" id="tr-raw2-error"></div>
                            </div>
                        </div>
                        <div class="input-field">
                            <label>Or enter percentage directly</label>
                            <input type="number" id="tr-percent" placeholder="e.g. 6" min="0" max="100">
                            <div class="validation-message" id="tr-percent-error"></div>
                        </div>
                    </div>
                </div>

                <!-- FQTS -->
                <div class="metric-card" id="card-fqts">
                    <div class="metric-header">
                        <div class="metric-title">
                            <span>Founder Queue Time Share</span>
                            <span class="metric-badge">FQTS</span>
                            <div class="help-icon">
                                ?
                                <div class="tooltip">Decision latency due to awaiting founder. The hidden cost of centralised approval. FQTS >30% means you're the constraint on execution velocity. Target: <20%</div>
                            </div>
                        </div>
                        <span class="status-chip" id="fqts-status"></span>
                    </div>
                    <div class="metric-body">
                        <div class="input-group">
                            <div class="input-field">
                                <label>Hours awaiting founder</label>
                                <input type="number" id="fqts-raw1" placeholder="e.g. 48" min="0">
                                <div class="validation-message" id="fqts-raw1-error"></div>
                            </div>
                            <div class="input-field">
                                <label>Total decision hours</label>
                                <input type="number" id="fqts-raw2" placeholder="e.g. 160" min="0">
                                <div class="validation-message" id="fqts-raw2-error"></div>
                            </div>
                        </div>
                        <div class="input-field">
                            <label>Or enter percentage directly</label>
                            <input type="number" id="fqts-percent" placeholder="e.g. 30" min="0" max="100">
                            <div class="validation-message" id="fqts-percent-error"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Dashboard -->
            <div class="panel">
                <h2>Market Risk Exposure</h2>
                
                <div style="text-align: center; margin-bottom: 30px;">
                    <h3 style="color: #6b7280; margin-bottom: 10px;">Overall Authority Gap Score</h3>
                    <div id="overall-score" style="font-size: 4rem; font-weight: 700; color: var(--primary);">--</div>
                    <div id="overall-status" style="font-size: 1.2rem; margin-top: 10px;"></div>
                </div>

                <div class="dashboard-grid">
                    <div class="metric-summary">
                        <h3>AAGI</h3>
                        <div class="metric-value" id="aagi-value">--</div>
                        <span class="status-chip" id="aagi-summary"></span>
                    </div>
                    <div class="metric-summary">
                        <h3>SAR</h3>
                        <div class="metric-value" id="sar-value">--</div>
                        <span class="status-chip" id="sar-summary"></span>
                    </div>
                    <div class="metric-summary">
                        <h3>ABU</h3>
                        <div class="metric-value" id="abu-value">--</div>
                        <span class="status-chip" id="abu-summary"></span>
                    </div>
                    <div class="metric-summary">
                        <h3>FGS</h3>
                        <div class="metric-value" id="fgs-value">--</div>
                        <span class="status-chip" id="fgs-summary"></span>
                    </div>
                    <div class="metric-summary">
                        <h3>DTF</h3>
                        <div class="metric-value" id="dtf-value">--</div>
                        <span class="status-chip" id="dtf-summary"></span>
                    </div>
                    <div class="metric-summary">
                        <h3>TR</h3>
                        <div class="metric-value" id="tr-value">--</div>
                        <span class="status-chip" id="tr-summary"></span>
                    </div>
                    <div class="metric-summary">
                        <h3>FQTS</h3>
                        <div class="metric-value" id="fqts-value">--</div>
                        <span class="status-chip" id="fqts-summary"></span>
                    </div>
                </div>

                <!-- AAGI Callout - Always Visible -->
                <div class="aagi-callout" id="aagi-callout">
                    <h4 id="aagi-callout-title">Authority-Accountability Gap (AAGI)</h4>
                    <div class="aagi-status" id="aagi-callout-value" style="color: #6b7280;">Not yet measured</div>
                    <div class="aagi-impact" id="aagi-callout-impact" style="color: var(--dark); font-weight: 500;">You cannot hold someone accountable for an outcome they lack authority to deliver. Each mismatched OKR represents structural failure, not performance issues.</div>
                    <div class="aagi-action" id="aagi-callout-action" style="color: var(--secondary); font-weight: 600;">Zero mismatched OKRs is the only acceptable target. Count carefully.</div>
                </div>

                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Insights Panel -->
        <div class="panel">
            <h2>Live Contextual Insights</h2>
            <div id="insights-container"></div>
            
            <div class="recovery-timeline">
                <h3>Systematic Dependency Reduction Timeline</h3>
                <div class="timeline-item">
                    <strong>Week 1: Measure What Markets Price</strong> â€” Complete decision log, map authority bands, execute 48-hour absence test
                </div>
                <div class="timeline-item">
                    <strong>Month 1: Deploy Instrumentation</strong> â€” Dashboard tracking these seven metrics weekly, written criteria for top 10 approval patterns
                </div>
                <div class="timeline-item">
                    <strong>Month 3: Operational Proof</strong> â€” Week-long absence without operational disruption, SAR <15%, DTF showing consistent growth
                </div>
            </div>
        </div>

        <!-- Snapshot Comparison Panel -->
        <div class="panel" id="snapshot-panel" style="display: none;">
            <h2>Snapshot Comparison</h2>
            <div id="snapshot-list"></div>
            <div id="comparison-view" style="margin-top: 20px;"></div>
        </div>

        <!-- Methodology Note -->
        <div class="panel" style="background: #f3f4f6; border-left: 4px solid var(--secondary);">
            <h2>Methodology Note</h2>
            <p style="margin-bottom: 12px; line-height: 1.7;">This framework derives from strategic consulting practice with founder-dependent UK SMEs. The seven metrics identify patterns observed when investor interest deteriorates due to key person risk.</p>
            <p style="line-height: 1.7;"><strong style="color: var(--primary);">Data collection minimum:</strong> One week of decision tracking across all seven metrics. Scores without baseline tracking are directional only and may underestimate founder dependency during operational stress periods.</p>
        </div>

        <!-- Action Panel -->
        <div class="panel">
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="saveSnapshot()" title="Save current metric values with timestamp for trend tracking">Save Snapshot</button>
                <button class="btn btn-secondary" onclick="toggleSnapshotView()" title="View saved snapshots and compare trends over time">Compare Snapshots</button>
                <button class="btn btn-secondary" onclick="exportData()" title="Download all data as JSON file for backup or external analysis">Export Data</button>
                <button class="btn btn-primary" onclick="downloadPDF()" title="Generate printer-friendly report of current diagnostic results">Print Report</button>
                <button class="btn btn-primary" onclick="showResetModal()" style="background: #dc2626;" title="Permanently delete all metrics and snapshots (requires confirmation)">Reset All Data</button>
            </div>
        </div>
    </div>

    <!-- Reset Modal -->
    <div class="modal" id="reset-modal">
        <div class="modal-content">
            <h3>Confirm Data Reset</h3>
            <p>This will permanently delete all entered metrics and snapshots. This action cannot be undone.</p>
            <p><strong>Type DELETE to confirm:</strong></p>
            <input type="text" id="reset-confirmation" placeholder="Type DELETE">
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="closeResetModal()" style="background: #6b7280;">Cancel</button>
                <button class="btn btn-primary" onclick="confirmReset()" style="background: #dc2626;">Reset All Data</button>
            </div>
        </div>
    </div>

    <!-- Disclaimer Footer -->
    <div style="background: #fff7ed; border: 2px solid #f59e0b; padding: 20px; margin: 40px 20px 20px 20px; border-radius: 8px; max-width: 1200px; margin-left: auto; margin-right: auto;">
        <h3 style="color: #92400e; margin-bottom: 10px; font-size: 1.1rem;">Disclaimer</h3>
        <p style="font-size: 0.9rem; color: #78350f; line-height: 1.6;">This diagnostic tool provides indicative guidance based on self-reported data. Scores and recommendations are for informational purposes only and do not constitute professional business, legal, or financial advice. Organisational complexity varies; results should be interpreted within your specific context. For implementation support, contact Strategy Hub directly via strategyhub.co.uk.</p>
    </div>

    <footer>
        <p>&copy; 2025 Strategy Hub. Framework Methodology.</p>
        <p style="margin-top: 5px;">Authority Gap Diagnostic Tool | <a href="https://strategyhub.co.uk" style="color: #2563eb;">strategyhub.co.uk</a></p>
    </footer>

    <script>
        let metrics = {
            aagi: { value: null, target: 0, critical: 5 },
            sar: { value: null, target: 10, critical: 30 },
            abu: { value: null, target: 80, critical: 48 },
            fgs: { value: null, target: 15, critical: 25 },
            dtf: { value: null, target: 70, critical: 42 },
            tr: { value: null, target: 3, critical: 7 },
            fqts: { value: null, target: 20, critical: 30 }
        };
        let snapshots = [];
        let radarChart = null;

        window.addEventListener('DOMContentLoaded', () => {
            loadFromStorage();
            initializeEventListeners();
            updateDashboard();
            updateProgressIndicator();
            highlightNextMetric();
        });

        function loadFromStorage() {
            const saved = localStorage.getItem('authorityGapData');
            if (saved) {
                const data = JSON.parse(saved);
                metrics = data.metrics || metrics;
                snapshots = data.snapshots || [];
                
                Object.keys(metrics).forEach(key => {
                    if (metrics[key].value !== null) {
                        const percentInput = document.getElementById(`${key}-percent`);
                        const directInput = document.getElementById(`${key}-direct`);
                        if (percentInput) percentInput.value = metrics[key].value;
                        if (directInput) directInput.value = metrics[key].value;
                    }
                });
            }
        }

        function saveToStorage() {
            localStorage.setItem('authorityGapData', JSON.stringify({
                metrics,
                snapshots,
                timestamp: new Date().toISOString()
            }));
        }

        function initializeEventListeners() {
            document.querySelectorAll('.metric-header').forEach(header => {
                header.addEventListener('click', () => {
                    const body = header.nextElementSibling;
                    body.classList.toggle('active');
                });
            });

            ['aagi', 'sar', 'abu', 'fgs', 'dtf', 'tr', 'fqts'].forEach(metric => {
                const raw1 = document.getElementById(`${metric}-raw1`);
                const raw2 = document.getElementById(`${metric}-raw2`);
                const percent = document.getElementById(`${metric}-percent`);
                const direct = document.getElementById(`${metric}-direct`);

                if (raw1 && raw2) {
                    raw1.addEventListener('input', () => {
                        validateInput(raw1, `${metric}-raw1`);
                        calculateFromRaw(metric);
                    });
                    raw2.addEventListener('input', () => {
                        validateInput(raw2, `${metric}-raw2`);
                        calculateFromRaw(metric);
                    });
                }

                if (percent) {
                    percent.addEventListener('input', () => {
                        if (validateInput(percent, `${metric}-percent`) && percent.value) {
                            metrics[metric].value = parseFloat(percent.value);
                            if (raw1 && raw2) {
                                raw1.value = '';
                                raw2.value = '';
                            }
                            updateMetricStatus(metric);
                            updateDashboard();
                            updateProgressIndicator();
                            highlightNextMetric();
                            saveToStorage();
                        }
                    });
                }

                if (direct) {
                    direct.addEventListener('input', () => {
                        if (validateInput(direct, `${metric}-direct`) && direct.value) {
                            metrics[metric].value = parseFloat(direct.value);
                            if (raw1 && raw2) {
                                raw1.value = '';
                                raw2.value = '';
                            }
                            updateMetricStatus(metric);
                            updateDashboard();
                            updateProgressIndicator();
                            highlightNextMetric();
                            saveToStorage();
                        }
                    });
                }
            });
        }

        function validateInput(input, fieldId) {
            const errorEl = document.getElementById(`${fieldId}-error`);
            const value = parseFloat(input.value);
            
            if (!input.value) {
                input.classList.remove('invalid');
                errorEl.classList.remove('show');
                return true;
            }

            if (value < 0) {
                input.classList.add('invalid');
                errorEl.textContent = 'Value cannot be negative';
                errorEl.classList.add('show');
                return false;
            }

            if (fieldId.includes('percent') && value > 100) {
                input.classList.add('invalid');
                errorEl.textContent = 'Percentage cannot exceed 100%';
                errorEl.classList.add('show');
                return false;
            }

            // Logical consistency checks
            const metric = fieldId.split('-')[0];
            if (metric === 'sar' && value > 50 && metrics.abu.value > 80) {
                errorEl.textContent = 'Warning: High SAR contradicts high ABU. Review band definitions.';
                errorEl.classList.add('warning', 'show');
            } else {
                errorEl.classList.remove('show', 'warning');
            }

            input.classList.remove('invalid');
            return true;
        }

        function calculateFromRaw(metric) {
            const raw1 = document.getElementById(`${metric}-raw1`);
            const raw2 = document.getElementById(`${metric}-raw2`);
            const percent = document.getElementById(`${metric}-percent`);
            const direct = document.getElementById(`${metric}-direct`);

            if (raw1.value && raw2.value) {
                const val1 = parseFloat(raw1.value);
                const val2 = parseFloat(raw2.value);

                if (val2 === 0) {
                    const errorEl = document.getElementById(`${metric}-raw2-error`);
                    errorEl.textContent = 'Cannot divide by zero';
                    errorEl.classList.add('show');
                    return;
                }

                if (metric === 'aagi') {
                    metrics[metric].value = val1;
                    if (direct) direct.value = val1;
                } else {
                    const value = (val1 / val2) * 100;
                    metrics[metric].value = Math.round(value * 10) / 10;
                    if (percent) percent.value = metrics[metric].value;
                }
                updateMetricStatus(metric);
                updateDashboard();
                updateProgressIndicator();
                highlightNextMetric();
                saveToStorage();
            }
        }

        function updateProgressIndicator() {
            const completed = Object.values(metrics).filter(m => m.value !== null).length;
            const total = Object.keys(metrics).length;
            const percentage = Math.round((completed / total) * 100);

            document.getElementById('progress-text').textContent = 
                `${completed} of ${total} metrics completed (${percentage}%)`;
            document.getElementById('progress-fill').style.width = `${percentage}%`;
        }

        function highlightNextMetric() {
            const metricOrder = ['aagi', 'sar', 'abu', 'fgs', 'dtf', 'tr', 'fqts'];
            
            // Remove all highlights
            metricOrder.forEach(metric => {
                document.getElementById(`card-${metric}`).classList.remove('needs-attention');
            });

            // Find first incomplete metric
            for (let metric of metricOrder) {
                if (metrics[metric].value === null) {
                    document.getElementById(`card-${metric}`).classList.add('needs-attention');
                    break;
                }
            }
        }

        function updateMetricStatus(metric) {
            const status = document.getElementById(`${metric}-status`);
            const value = metrics[metric].value;
            
            if (value === null) {
                status.innerHTML = '';
                return;
            }

            let statusClass = 'status-green';
            let statusText = 'âœ“ Healthy';

            if (metric === 'aagi') {
                if (value === 0) {
                    statusClass = 'status-green';
                    statusText = 'âœ“ Target State';
                } else if (value <= 5) {
                    statusClass = 'status-amber';
                    statusText = 'âš  Structural Gap';
                } else {
                    statusClass = 'status-red';
                    statusText = 'âœ• Governance Failure';
                }
            } else if (['sar', 'fgs', 'tr', 'fqts'].includes(metric)) {
                if (value <= metrics[metric].target) {
                    statusClass = 'status-green';
                    statusText = 'âœ“ Healthy';
                } else if (value <= metrics[metric].critical) {
                    statusClass = 'status-amber';
                    statusText = 'âš  Authority Theatre';
                } else {
                    statusClass = 'status-red';
                    statusText = 'âœ• Bottleneck';
                }
            } else if (['abu', 'dtf'].includes(metric)) {
                if (value >= metrics[metric].target) {
                    statusClass = 'status-green';
                    statusText = 'âœ“ Healthy';
                } else if (value >= metrics[metric].critical) {
                    statusClass = 'status-amber';
                    statusText = 'âš  Suppressed Capability';
                } else {
                    statusClass = 'status-red';
                    statusText = 'âœ• Critical Gap';
                }
            }

            status.className = `status-chip ${statusClass}`;
            status.innerHTML = statusText;
        }

        function updateDashboard() {
            updateOverallScore();
            updateMetricSummaries();
            updateAAGICallout();
            generateInsights();
            renderChart();
        }

        function updateOverallScore() {
            const validMetrics = Object.entries(metrics).filter(([key, data]) => data.value !== null);
            
            if (validMetrics.length === 0) {
                document.getElementById('overall-score').textContent = '--';
                document.getElementById('overall-status').textContent = 'Enter metrics to calculate score';
                return;
            }

            let totalHealth = 0;
            validMetrics.forEach(([key, data]) => {
                let health = 0;
                
                if (key === 'aagi') {
                    health = data.value === 0 ? 100 : (data.value <= 5 ? 50 : 0);
                } else if (['sar', 'fgs', 'tr', 'fqts'].includes(key)) {
                    if (data.value <= data.target) {
                        health = 100;
                    } else if (data.value <= data.critical) {
                        health = 50 + 50 * (data.critical - data.value) / (data.critical - data.target);
                    } else {
                        health = Math.max(0, 50 * (100 - data.value) / (100 - data.critical));
                    }
                } else {
                    if (data.value >= data.target) {
                        health = 100;
                    } else if (data.value >= data.critical) {
                        health = 50 + 50 * (data.value - data.critical) / (data.target - data.critical);
                    } else {
                        health = Math.max(0, 50 * data.value / data.critical);
                    }
                }
                
                totalHealth += health;
            });

            const overallScore = Math.round(totalHealth / validMetrics.length);
            document.getElementById('overall-score').textContent = overallScore;
            
            let status = '';
            let color = '';
            if (overallScore >= 80) {
                status = 'Minimal founder dependency â€” enterprise ready';
                color = 'var(--success)';
            } else if (overallScore >= 60) {
                status = 'Moderate dependency â€” delegation gaps identified';
                color = 'var(--warning)';
            } else if (overallScore >= 40) {
                status = 'Significant bottlenecks â€” systematic intervention required';
                color = 'var(--warning)';
            } else {
                status = 'Critical founder dependency â€” valuation risk material';
                color = 'var(--danger)';
            }
            
            const statusElement = document.getElementById('overall-status');
            statusElement.textContent = status;
            statusElement.style.color = color;
            document.getElementById('overall-score').style.color = color;
        }

        function updateMetricSummaries() {
            ['aagi', 'sar', 'abu', 'fgs', 'dtf', 'tr', 'fqts'].forEach(key => {
                const valueEl = document.getElementById(`${key}-value`);
                const summaryEl = document.getElementById(`${key}-summary`);
                
                if (metrics[key].value !== null) {
                    if (key === 'aagi') {
                        valueEl.textContent = metrics[key].value;
                    } else {
                        valueEl.textContent = metrics[key].value + '%';
                    }
                    
                    updateMetricStatus(key);
                    const status = document.getElementById(`${key}-status`);
                    summaryEl.className = status.className;
                    summaryEl.innerHTML = status.innerHTML;
                } else {
                    valueEl.textContent = '--';
                    summaryEl.innerHTML = '';
                }
            });
        }

        function updateAAGICallout() {
            const callout = document.getElementById('aagi-callout');
            const titleEl = document.getElementById('aagi-callout-title');
            const valueEl = document.getElementById('aagi-callout-value');
            const impactEl = document.getElementById('aagi-callout-impact');
            const actionEl = document.getElementById('aagi-callout-action');
            
            if (metrics.aagi.value === null) {
                valueEl.textContent = 'Not yet measured';
                valueEl.style.color = '#6b7280';
                impactEl.innerHTML = 'You cannot hold someone accountable for an outcome they lack authority to deliver. Each mismatched OKR represents structural failure, not performance issues.';
                impactEl.style.color = 'var(--dark)';
                impactEl.style.fontWeight = '500';
                actionEl.textContent = 'Zero mismatched OKRs is the only acceptable target. Count carefully.';
                actionEl.style.color = 'var(--secondary)';
                actionEl.style.fontWeight = '600';
                callout.style.background = '#f8f9fa';
                callout.style.borderLeftColor = '#f59e0b';
                return;
            }

            titleEl.textContent = 'Authority-Accountability Gap (AAGI)';
            
            const count = metrics.aagi.value;
            valueEl.textContent = `${count} ${count === 1 ? 'OKR' : 'OKRs'} mismatched`;

            if (count === 0) {
                callout.style.background = '#d1fae5';
                callout.style.borderLeftColor = '#059669';
                valueEl.style.color = '#047857';
                impactEl.innerHTML = '<strong>Target state achieved.</strong> All OKRs have properly aligned decision rights. This is mature governance.';
                impactEl.style.color = '#065f46';
                impactEl.style.fontWeight = '600';
                actionEl.textContent = 'â†’ Maintain this alignment as organisation scales';
                actionEl.style.color = '#047857';
                actionEl.style.fontWeight = '500';
            } else if (count === 1) {
                callout.style.background = '#fed7aa';
                callout.style.borderLeftColor = '#f59e0b';
                valueEl.style.color = '#92400e';
                impactEl.innerHTML = '<strong>Material governance gap.</strong> Even one mismatched OKR signals structural failure requiring immediate attention.';
                impactEl.style.color = '#92400e';
                impactEl.style.fontWeight = '600';
                actionEl.textContent = 'â†’ Review this OKR owner\'s authority within 48 hours';
                actionEl.style.color = '#047857';
                actionEl.style.fontWeight = '500';
            } else if (count <= 5) {
                callout.style.background = '#fed7aa';
                callout.style.borderLeftColor = '#f59e0b';
                valueEl.style.color = '#92400e';
                impactEl.innerHTML = `<strong>Systematic governance failure.</strong> Multiple misaligned OKRs indicate fundamental structural problems, not individual issues.`;
                impactEl.style.color = '#92400e';
                impactEl.style.fontWeight = '600';
                actionEl.textContent = 'â†’ Schedule authority realignment session within 7 days';
                actionEl.style.color = '#047857';
                actionEl.style.fontWeight = '500';
            } else {
                callout.style.background = '#fee2e2';
                callout.style.borderLeftColor = '#dc2626';
                valueEl.style.color = '#991b1b';
                impactEl.innerHTML = `<strong>Critical structural breakdown.</strong> Organisation has authority theatre, not genuine accountability framework.`;
                impactEl.style.color = '#991b1b';
                impactEl.style.fontWeight = '600';
                actionEl.textContent = 'â†’ Zero-base all decision rights this month';
                actionEl.style.color = '#047857';
                actionEl.style.fontWeight = '500';
            }
        }

        function renderChart() {
            const validMetrics = Object.entries(metrics).filter(([key, data]) => data.value !== null);
            
            if (validMetrics.length === 0) return;

            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // Calculate health scores for all metrics (0-100 scale)
            const healthScores = ['aagi', 'sar', 'abu', 'fgs', 'dtf', 'tr', 'fqts'].map(key => {
                if (metrics[key].value === null) return 0;
                
                const data = metrics[key];
                let health = 0;
                
                if (key === 'aagi') {
                    health = data.value === 0 ? 100 : (data.value <= 5 ? 50 : 0);
                } else if (['sar', 'fgs', 'tr', 'fqts'].includes(key)) {
                    if (data.value <= data.target) {
                        health = 100;
                    } else if (data.value <= data.critical) {
                        health = 50 + 50 * (data.critical - data.value) / (data.critical - data.target);
                    } else {
                        health = Math.max(0, 50 * (100 - data.value) / (100 - data.critical));
                    }
                } else {
                    if (data.value >= data.target) {
                        health = 100;
                    } else if (data.value >= data.critical) {
                        health = 50 + 50 * (data.value - data.critical) / (data.target - data.critical);
                    } else {
                        health = Math.max(0, 50 * data.value / data.critical);
                    }
                }
                
                return Math.round(health);
            });

            if (radarChart) {
                radarChart.destroy();
            }

            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['AAGI', 'SAR', 'ABU', 'FGS', 'DTF', 'TR', 'FQTS'],
                    datasets: [{
                        label: 'Health Score',
                        data: healthScores,
                        fill: true,
                        backgroundColor: 'rgba(26, 58, 75, 0.2)',
                        borderColor: '#1a3a4b',
                        pointBackgroundColor: '#1a3a4b',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#1a3a4b',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            },
                            pointLabels: {
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function generateInsights() {
            const container = document.getElementById('insights-container');
            const insights = [];

            const aagi = metrics.aagi.value;
            const sar = metrics.sar.value;
            const abu = metrics.abu.value;
            const fgs = metrics.fgs.value;
            const dtf = metrics.dtf.value;
            const tr = metrics.tr.value;
            const fqts = metrics.fqts.value;

            if (sar >= 14 && tr >= 6) {
                insights.push({
                    title: 'Trust Deficit Pattern Detected',
                    values: `SAR: ${sar}%, TR: ${tr}%`,
                    impact: 'You\'re granting authority on paper, withdrawing it in practice. Systematic reversals train teams to seek approval regardless of formal bands. This isn\'t delegationâ€”it\'s authority theatre.',
                    action: 'Write explicit delegation criteria and freeze reversals for 14 days. Track outcomes.'
                });
            }

            if (fqts > 30 && snapshots.length > 0) {
                const lastSnapshot = snapshots[snapshots.length - 1];
                if (lastSnapshot.metrics.fqts?.value > 30) {
                    insights.push({
                        title: 'Persistent Queue Bottleneck (2+ Periods)',
                        values: `FQTS: ${fqts}%`,
                        impact: 'Chronic founder response delays compound across organisation. Execution velocity constrained by single-point approval.',
                        action: 'Drop approval bands by one level for 30 days. Measure throughput changes.'
                    });
                }
            }

            if (fqts > 30 && fgs > 18) {
                insights.push({
                    title: 'Founder Gating Crisis',
                    values: `FQTS: ${fqts}%, FGS: ${fgs}%`,
                    impact: 'Meeting and decision bottlenecks compound latency. You\'re the organisational constraint, not the strategic leader.',
                    action: 'Route through ops triage; auto-approve sub-Â£5k with sampling audit. Immediate implementation.'
                });
            }

            if (dtf < 56 && sar >= 14) {
                insights.push({
                    title: 'Systematic Over-Centralisation',
                    values: `DTF: ${dtf}%, SAR: ${sar}%`,
                    impact: 'Organisational capability exists but is suppressed by approval dependency. Team throughput artificially constrained.',
                    action: 'Reassign top 5 recurring decisions to leads with SLAs. Track resolution rates weekly.'
                });
            }

            if (aagi > 5 && fgs > 18) {
                insights.push({
                    title: 'Authority-Accountability Structural Failure',
                    values: `AAGI: ${aagi}, FGS: ${fgs}%`,
                    impact: 'OKR owners cannot execute outcomes they\'re measured on. Governance framework is fundamentally broken, not misaligned.',
                    action: 'Zero-base all OKR decision rights within 7 days. This is structural, not tactical.'
                });
            }

            if (abu < 64 && tr > 6) {
                insights.push({
                    title: 'Band Clarity Crisis',
                    values: `ABU: ${abu}%, TR: ${tr}%`,
                    impact: 'Unclear bands driving elevation and reversals. Teams lack confidence in what they can decide independently.',
                    action: 'Republish bands with specific examples; require written exception analysis pre-reversal.'
                });
            }

            if (snapshots.length > 0) {
                const lastSAR = snapshots[snapshots.length - 1].metrics.sar?.value;
                const lastAAGI = snapshots[snapshots.length - 1].metrics.aagi?.value;
                if (lastSAR && sar < lastSAR && aagi === lastAAGI) {
                    insights.push({
                        title: 'Tactical Improvement, Structural Gap Persists',
                        values: `SAR declining, AAGI unchanged: ${aagi}`,
                        impact: 'Approvals improving but governance structure remains misaligned. Treating symptoms, not root cause.',
                        action: 'Convert 3 OKR owners into decision owners with matching authority bands.'
                    });
                }
            }

            if (abu >= 80 && tr > 6) {
                insights.push({
                    title: 'Inconsistent Override Pattern',
                    values: `ABU: ${abu}%, TR: ${tr}%`,
                    impact: 'Strong band compliance undermined by frequent reversals. Sends mixed signals about genuine delegation.',
                    action: 'Enforce "no silent reversals" policy. Require documented reasoning and coaching session.'
                });
            }

            if (dtf > 60 && sar >= 14) {
                insights.push({
                    title: 'Latent Capability Underutilised',
                    values: `DTF: ${dtf}%, SAR: ${sar}%`,
                    impact: 'Non-founder capability proven but artificially gated by shadow approvals. Organisational capacity exists but is suppressed.',
                    action: 'Accelerate authority migration to proven performers. They\'re ready; you\'re the constraint.'
                });
            }

            if (fgs > 25) {
                insights.push({
                    title: 'Meeting Bottleneck Critical',
                    values: `FGS: ${fgs}%`,
                    impact: 'Quarter of meetings blocked awaiting founder decision. Execution velocity constrained at systematic level.',
                    action: 'Appoint deputy decision maker closer to operational work. Immediate delegation required.'
                });
            }

            container.innerHTML = '';
            insights.slice(0, 5).forEach(insight => {
                const div = document.createElement('div');
                div.className = 'insight-item';
                div.innerHTML = `
                    <h4>${insight.title}</h4>
                    <div style="margin: 8px 0; color: #6b7280;">Measured: ${insight.values}</div>
                    <div class="insight-impact">Impact: ${insight.impact}</div>
                    <div class="insight-action">â†’ Action: ${insight.action}</div>
                `;
                container.appendChild(div);
            });

            if (insights.length === 0 && Object.values(metrics).some(m => m.value !== null)) {
                container.innerHTML = '<div class="insight-item"><p>Your metrics don\'t trigger priority alerts. Continue monitoring and re-measure after implementing changes. Authority gaps often emerge under stress conditions.</p></div>';
            } else if (insights.length === 0) {
                container.innerHTML = '<div class="insight-item"><p>Enter measurement data to generate contextual insights about authority gaps and systematic bottlenecks.</p></div>';
            }
        }

        function saveSnapshot() {
            const validMetrics = Object.values(metrics).filter(m => m.value !== null).length;
            if (validMetrics === 0) {
                alert('Please enter at least one metric before saving a snapshot.');
                return;
            }

            const snapshot = {
                date: new Date().toISOString(),
                metrics: JSON.parse(JSON.stringify(metrics)),
                overallScore: calculateOverallScoreValue()
            };
            snapshots.push(snapshot);
            saveToStorage();
            
            const dateStr = new Date().toLocaleDateString('en-GB', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            alert(`Snapshot saved: ${dateStr}\n\nTotal snapshots: ${snapshots.length}\n\nUse "Compare Snapshots" button to view trends.`);
        }

        function toggleSnapshotView() {
            const panel = document.getElementById('snapshot-panel');
            if (snapshots.length === 0) {
                alert('No snapshots saved yet. Save your first snapshot to enable comparison.');
                return;
            }
            
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                renderSnapshotComparison();
                panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                panel.style.display = 'none';
            }
        }

        function renderSnapshotComparison() {
            const listContainer = document.getElementById('snapshot-list');
            const comparisonContainer = document.getElementById('comparison-view');
            
            // Render snapshot list
            let listHTML = '<div style="margin-bottom: 20px;">';
            listHTML += '<h3 style="margin-bottom: 15px; color: var(--primary);">Saved Snapshots</h3>';
            listHTML += '<div style="display: grid; gap: 10px;">';
            
            snapshots.forEach((snapshot, index) => {
                const date = new Date(snapshot.date);
                const dateStr = date.toLocaleDateString('en-GB', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                listHTML += `
                    <div style="background: var(--subtle-bg); padding: 12px 15px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border);">
                        <div>
                            <strong>Snapshot ${index + 1}:</strong> ${dateStr}
                            <span style="margin-left: 15px; color: var(--primary); font-weight: 600;">Score: ${snapshot.overallScore}</span>
                        </div>
                        <button onclick="deleteSnapshot(${index})" style="background: var(--danger); color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">Delete</button>
                    </div>
                `;
            });
            
            listHTML += '</div></div>';
            listContainer.innerHTML = listHTML;
            
            // Render comparison if we have 2+ snapshots
            if (snapshots.length >= 2) {
                renderSnapshotTrends(comparisonContainer);
            } else {
                comparisonContainer.innerHTML = '<p style="color: #6b7280; font-style: italic;">Save at least 2 snapshots to view trend comparisons.</p>';
            }
        }

        function renderSnapshotTrends(container) {
            const latest = snapshots[snapshots.length - 1];
            const previous = snapshots[snapshots.length - 2];
            
            const latestDate = new Date(latest.date).toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
            const previousDate = new Date(previous.date).toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
            
            let html = '<div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 20px;">';
            html += '<h3 style="margin-bottom: 15px; color: var(--primary);">Trend Analysis: Latest vs Previous</h3>';
            html += `<p style="margin-bottom: 20px; color: #6b7280;">Comparing ${previousDate} â†’ ${latestDate}</p>`;
            
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
            
            // Overall Score Comparison
            const scoreDelta = latest.overallScore - previous.overallScore;
            const scoreArrow = scoreDelta > 0 ? 'â†‘' : scoreDelta < 0 ? 'â†“' : 'â†’';
            const scoreColor = scoreDelta > 0 ? 'var(--success)' : scoreDelta < 0 ? 'var(--danger)' : '#6b7280';
            
            html += `
                <div style="background: var(--subtle-bg); padding: 15px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 5px;">Overall Score</div>
                    <div style="font-size: 1.8rem; font-weight: 700; color: ${scoreColor};">
                        ${scoreArrow} ${Math.abs(scoreDelta)}
                    </div>
                    <div style="font-size: 0.9rem; margin-top: 5px;">
                        ${previous.overallScore} â†’ ${latest.overallScore}
                    </div>
                </div>
            `;
            
            // Individual Metric Comparisons
            ['aagi', 'sar', 'abu', 'fgs', 'dtf', 'tr', 'fqts'].forEach(key => {
                const prevValue = previous.metrics[key]?.value;
                const latestValue = latest.metrics[key]?.value;
                
                if (prevValue !== null && latestValue !== null) {
                    let delta = latestValue - prevValue;
                    let arrow, color;
                    
                    // For "lower is better" metrics (SAR, TR, FQTS, FGS, AAGI)
                    if (['sar', 'tr', 'fqts', 'fgs', 'aagi'].includes(key)) {
                        if (delta < 0) {
                            arrow = 'â†“';
                            color = 'var(--success)'; // Improvement
                        } else if (delta > 0) {
                            arrow = 'â†‘';
                            color = 'var(--danger)'; // Worsening
                        } else {
                            arrow = 'â†’';
                            color = '#6b7280';
                        }
                    } else {
                        // For "higher is better" metrics (ABU, DTF)
                        if (delta > 0) {
                            arrow = 'â†‘';
                            color = 'var(--success)';
                        } else if (delta < 0) {
                            arrow = 'â†“';
                            color = 'var(--danger)';
                        } else {
                            arrow = 'â†’';
                            color = '#6b7280';
                        }
                    }
                    
                    const displayValue = key === 'aagi' ? Math.abs(delta).toFixed(0) : Math.abs(delta).toFixed(1);
                    const unit = key === 'aagi' ? '' : '%';
                    
                    html += `
                        <div style="background: var(--subtle-bg); padding: 15px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 5px; font-weight: 600;">${key.toUpperCase()}</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${color};">
                                ${arrow} ${displayValue}${unit}
                            </div>
                            <div style="font-size: 0.9rem; margin-top: 5px;">
                                ${prevValue}${unit} â†’ ${latestValue}${unit}
                            </div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            
            // Interpretation
            html += '<div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-left: 4px solid var(--secondary); border-radius: 5px;">';
            html += '<strong style="color: var(--primary);">Interpretation:</strong> ';
            
            if (scoreDelta > 10) {
                html += 'Significant improvement in authority gap reduction. Delegation interventions showing measurable impact.';
            } else if (scoreDelta > 0) {
                html += 'Modest improvement. Continue current interventions and reassess in 2-4 weeks.';
            } else if (scoreDelta === 0) {
                html += 'Score stable. Review whether interventions are being implemented consistently.';
            } else if (scoreDelta > -10) {
                html += 'Slight regression. Common during operational stress periods. Reassess intervention effectiveness.';
            } else {
                html += 'Significant regression. Investigate whether new bottlenecks emerged or delegation reversed.';
            }
            
            html += '</div>';
            html += '</div>';
            
            container.innerHTML = html;
        }

        function deleteSnapshot(index) {
            if (!confirm(`Delete snapshot from ${new Date(snapshots[index].date).toLocaleDateString('en-GB')}?`)) {
                return;
            }
            
            snapshots.splice(index, 1);
            saveToStorage();
            
            if (snapshots.length === 0) {
                document.getElementById('snapshot-panel').style.display = 'none';
            } else {
                renderSnapshotComparison();
            }
        }

        function calculateOverallScoreValue() {
            const validMetrics = Object.entries(metrics).filter(([key, data]) => data.value !== null);
            if (validMetrics.length === 0) return 0;

            let totalHealth = 0;
            validMetrics.forEach(([key, data]) => {
                let health = 0;
                
                if (key === 'aagi') {
                    health = data.value === 0 ? 100 : (data.value <= 5 ? 50 : 0);
                } else if (['sar', 'fgs', 'tr', 'fqts'].includes(key)) {
                    if (data.value <= data.target) {
                        health = 100;
                    } else if (data.value <= data.critical) {
                        health = 50 + 50 * (data.critical - data.value) / (data.critical - data.target);
                    } else {
                        health = Math.max(0, 50 * (100 - data.value) / (100 - data.critical));
                    }
                } else {
                    if (data.value >= data.target) {
                        health = 100;
                    } else if (data.value >= data.critical) {
                        health = 50 + 50 * (data.value - data.critical) / (data.target - data.critical);
                    } else {
                        health = Math.max(0, 50 * data.value / data.critical);
                    }
                }
                
                totalHealth += health;
            });

            return Math.round(totalHealth / validMetrics.length);
        }

        function exportData() {
            const exportObj = {
                generated: new Date().toISOString(),
                overall_score: calculateOverallScoreValue(),
                metrics: metrics,
                snapshots: snapshots
            };
            
            const dataStr = JSON.stringify(exportObj, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `authority-gap-diagnostic-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function showResetModal() {
            document.getElementById('reset-modal').classList.add('show');
            document.getElementById('reset-confirmation').value = '';
        }

        function closeResetModal() {
            document.getElementById('reset-modal').classList.remove('show');
        }

        function confirmReset() {
            const confirmation = document.getElementById('reset-confirmation').value;
            if (confirmation !== 'DELETE') {
                alert('Please type DELETE exactly to confirm reset.');
                return;
            }

            Object.keys(metrics).forEach(key => {
                metrics[key].value = null;
            });

            snapshots = [];

            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.value = '';
                input.classList.remove('invalid');
            });

            document.querySelectorAll('.validation-message').forEach(el => {
                el.classList.remove('show');
            });

            localStorage.removeItem('authorityGapData');
            
            closeResetModal();
            updateDashboard();
            updateProgressIndicator();
            highlightNextMetric();
            
            if (radarChart) {
                radarChart.destroy();
                radarChart = null;
            }

            alert('All data has been reset');
        }

        function downloadPDF() {
            window.print();
        }
    </script>
</body>
</html>